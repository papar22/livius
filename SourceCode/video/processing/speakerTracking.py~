

import cv2
from numpy import empty, nan
import os
import sys
import time
import math
import CMT.CMT
import CMT.util as cmtutil
import numpy as np
from moviepy.editor import *


CMT = CMT.CMT.CMT()

class CMT_algorithm():



    def __init__(self,inputPath, outputDir = None, bBox = None , skip = None):
        self.inputPath = inputPath     # 'The input path.'
        self.outputDir = outputDir      # 'Specify a directory for output data.'
        self.bBox = bBox                # 'Specify initial bounding box.'
        self.skip = skip                # 'Skip the first n frames.'
        

       
    def speakerTracker(self):
        

        # Clean up
        cv2.destroyAllWindows()

        if self.inputPath is not None:

            # If a path to a file was given, assume it is a single video file
            if os.path.isfile(self.inputPath):
                cap = cv2.VideoCapture(self.inputPath)
                clip  = VideoFileClip(self.inputPath)

                #Skip first frames if required
                if self.skip is not None:
                    cap.set(cv2.cv.CV_CAP_PROP_POS_FRAMES, self.skip)

            # Otherwise assume it is a format string for reading images
            else:
                cap = cmtutil.FileVideoCapture(self.inputPath)

                #Skip first frames if required
                if self.skip is not None:
                    cap.frame = 1 + self.skip

        else:
            # If no input path was specified, open camera device
            sys.exit("Error: no input path was specified")

        # Read first frame
        status, im0 = cap.read()
        im_gray0 = cv2.cvtColor(im0, cv2.COLOR_BGR2GRAY)
        im_draw = np.copy(im0)

        if self.bBox is not None:
            # Try to disassemble user specified bounding box
            values = self.bBox.split(',')
            try:
                values = [int(v) for v in values]
            except:
                raise Exception('Unable to parse bounding box')
            if len(values) != 4:
                raise Exception('Bounding box must have exactly 4 elements')
            bbox = np.array(values)

            # Convert to point representation, adding singleton dimension
            bbox = cmtutil.bb2pts(bbox[None, :])

            # Squeeze
            bbox = bbox[0, :]

            tl = bbox[:2]
            br = bbox[2:4]
        else:
            # Get rectangle input from user
            (tl, br) = cmtutil.get_rect(im_draw)

        print 'using', tl, br, 'as init bb'

        CMT.initialise(im_gray0, tl, br)

        framenum = 1

        finalCoordinates = []
        centerCoordinates = []           
        new_frames = []
        windowSize = (640,360)
        defaultFrame = np.zeros((windowSize[0],windowSize[1],3))
        

        for frame in clip.iter_frames(fps=clip.fps, with_times=False, progress_bar=False, dtype='uint8'):

            
            im_gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
            im_draw = np.copy(frame)

            tic = time.time()
            CMT.process_frame(im_gray)
            toc = time.time()
            
            if math.isnan(CMT.center[0]) or math.isnan(CMT.center[1]):
                new_frames.append(defaultFrame)
                finalCoordinates.append(( (0,0), (0,0), (0,0), (0,0) ))
                centerCoordinates.append((0, 0))
            else:        
                x1 = np.floor(np.abs(CMT.center[1] - windowSize[1]/2))
                y1 = np.floor(np.abs(CMT.center[0] - windowSize[0]/2))
                x2 = np.floor(x1 + windowSize[1])
                y2 = np.floor(y1 + windowSize[0])
                new_frames.append(frame[x1:x2,y1:y2,:])
                finalCoordinates.append((CMT.tl, CMT.tr, CMT.br, CMT.bl))
                centerCoordinates.append((CMT.center[0], CMT.center[1]))
                #print (x1, x2, y1, y2)

            # Remember image
            im_prev = im_gray

            # Advance frame number
            print 'Frame: {2:4d} , Center: {0:.2f},{1:.2f}'.format(CMT.center[0], CMT.center[1] , framenum)

            framenum += 1
            # Converting python list to numpy array and return the array
            
        return np.asarray(finalCoordinates, dtype=np.float32) , np.asarray(centerCoordinates, dtype=np.float32) , new_frames    
        #return new_frames

    
    
    
    
if __name__ == '__main__':
    
    targetVideo = "/media/pbahar/Data Raid/Videos/18.03.2015/video2.mp4"
    obj = CMT_algorithm(targetVideo)
    
    finalCoordinates , points, aa = obj.speakerTracker()
    #print np.asarray(points, dtype=np.float32)    # Converting python list to numpy array
    new_clip = ImageSequenceClip(aa, fps=30)
    new_clip.write_videofile("speakerpart.mp4") 
    
 
    
